name: Build and upload proxy client to JFrog

on:
  push:
    branches:
      - stage
      # TODO: snapshots_private has been removed from base parent pom.xml.  Need to add workflow code to write snapshots_private to local pipeline pom.xml (this workflow will not work until that is done)

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Java client
      uses: actions/checkout@v2

    - name: Set up settings.xml for Maven
      uses: s4u/maven-settings-action@v2.8.0
      with:
        servers: '[{"id": "snapshots_private", "username": "${{ secrets.JFROG_USERNAME }}", "password": "${{ secrets.JFROG_MAVEN_TOKEN }}"}]'

    # Using a different settings.xml Github Action because the one above
    # doesn't support editing profiles
    - name: Add internal JFrog repo to pom.xml
      uses: whelk-io/maven-settings-xml-action@v20
      with:
        profiles: >
          [
            {
              "id": "snapshot_repositories",
              "repositories": {
                "repository": {
                  "id": "snapshots_private",
                  "name": "Aerospike private JFrog repo"
                  "url": "${{ secrets.JFROG_MAVEN_REPO_URL }}"
                }
              }
            }
          ]
        active_profiles: >
          [
            "snapshot_repositories"
          ]

    - name: Build Java client
      run: mvn install

    - name: Upload to JFrog
      run: mvn deploy
