name: Build and upload proxy client to JFrog

on:
  push:
    branches:
      - stage
      # TODO: remove this once proxy branch is removed
      - proxy
  pull_request:
    branches:
      # TODO: remove this once proxy branch is removed
      - proxy
      - stage

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Java client
      uses: actions/checkout@v2

    - name: Build Java client
      run: mvn install

    - name: Set up settings.xml for Maven
      uses: s4u/maven-settings-action@v2.8.0
      with:
        servers: '[{"id": "snapshots_private", "username": "${{ secrets.JFROG_USERNAME }}", "password": "${{ secrets.JFROG_MAVEN_TOKEN }}"}]'

    - name: Trigger test workflow remotely (uses DBaaS dev environment)
      run: Aerospike-DBaaS/integration-tests/.github/workflows/test-client-dev.yml@main

    # Only push to JFrog once the PR has been merged
    # We assume that the PR branch has already passed testing and is a viable release candidate
    - name: Upload to JFrog
      run: mvn deploy
      if: ${{ github.event_name == "push" }}
