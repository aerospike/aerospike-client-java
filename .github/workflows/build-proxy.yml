name: Build and upload proxy client to JFrog

on:
  pull_request:
  push:
    branches:
      - stage
      # TODO: snapshots_private has been removed from base parent pom.xml.  Need to add workflow code to write snapshots_private to local pipeline pom.xml (this workflow will not work until that is done)

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Java client
      uses: actions/checkout@v2

    - name: Set up settings.xml for Maven
      uses: s4u/maven-settings-action@v2.8.0
      with:
        servers: '[{"id": "snapshots_private", "username": "${{ secrets.JFROG_USERNAME }}", "password": "${{ secrets.JFROG_MAVEN_TOKEN }}"}]'

    - name: Build Java client
      run: mvn install

    - name: Run Aerospike server
      run: docker run -d --name aerospike-server -p 3000:3000 aerospike/aerospike-server

    - name: Run Aerospike Proxy
      run: docker run -d --name aerospike-proxy-4000 -p 4000:4000 aerospike.jfrog.io/docker/aerospike/aerospike-proxy-private

    - name: Run tests
      run: mvn test -Dtest=com.aerospike.proxy.tests.ProxyTests

    # - name: Upload to JFrog
    #   run: mvn deploy
