name: Build and est
description: "Build and test code base"

inputs:
  crypto-type:
    description: ""
    required: false
    default: gnu
  use-server-rc:
    required: false
    default: "false"
    description: "Test against server release candidate?"
  server-tag:
    required: false
    default: "latest"
    description: "Server docker image tag"
  jfrog-docker-username:
    required: true
    description: ""
  jfrog-docker-token:
    required: true
    description: ""
  run-tests:
    required: true
    default: "false"
    description: Spin up aerospike enterprise server and run tests

runs:
  using: "composite"
  steps:
    # Using script to set profile since we would like to have the sticky effect. Set it once and have it
    # remain for remainder of the job
    - name: Stage crypto
      shell: bash
      run: |
        ./set_crypto ${{ inputs.crypto-type }}

    - name: Build
      shell: bash
      run: mvn clean install

    - name: Run EE server
      if: ${{ inputs.run-tests == 'true' }}
      uses: ./.github/actions/run-ee-server
      with:
        use-server-rc: ${{ inputs.use-server-rc }}
        server-tag: ${{ inputs.server-tag }}
        docker-hub-username: ${{ inputs.jfrog-docker-username }}
        docker-hub-password: ${{ inputs.jfrog-docker-token }}

    - name: Run tests
      shell: bash
      if: ${{ inputs.run-tests == true }}
      working-directory: test
      run: mvn test -DskipTests=false
